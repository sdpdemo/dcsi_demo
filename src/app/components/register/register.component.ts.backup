import { Component, OnInit, AfterViewInit } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { Router } from '@angular/router';
import { HttpClient } from '@angular/common/http';
import { AuthService } from '../../services/auth.service';

declare var window: any;

@Component({
  selector: 'app-register',
  templateUrl: './register.component.html',
  styleUrls: ['./register.component.css', '../../../assets/consent-styles.css']
})
export class RegisterComponent implements OnInit, AfterViewInit {
  registerForm!: FormGroup;
  errorMessage: string = '';
  isLoading: boolean = false;
  consentSubmitted: boolean = false;
  private consentData: any = null;

  constructor(
    private fb: FormBuilder,
    private authService: AuthService,
    private router: Router,
    private http: HttpClient
  ) {}

  ngOnInit(): void {
    this.registerForm = this.fb.group({
      name: ['', [Validators.required, Validators.minLength(2)]],
      email: ['', [Validators.required, Validators.email]]
    });
  }

  ngAfterViewInit(): void {
    this.initConsentWidget();
  }

  get name() {
    return this.registerForm.get('name');
  }

  get email() {
    return this.registerForm.get('email');
  }

  private initConsentWidget(): void {
    // Set up consent widget configuration
    window.consentWidgetConfig = {
      consentFormId: "29ee965d-f647-499b-848d-a52d077f1476",
      apiUrl: "https://qa-op.pre-dataprivacy.com/cpm-api/consent/v1/getConsentFormById",
      submitApiUrl: "https://qa-op.pre-dataprivacy.com/cpm-api/consent/v1/createOrUpdateConsent",
      showButtons: false,
      showLanguageDropdown: true,
      enableCheckboxes: true,
      enableRadioButtons: true,
      enableDropdowns: true
    };

    // Load the consent widget script
    this.loadConsentScript();
  }

  private loadConsentScript(): void {
    // Load the consent widget script from assets
    const script = document.createElement('script');
    script.src = 'assets/consent-script.js';
    script.async = false;
    document.body.appendChild(script);

    // Wait for script to load, then override the sendConsent function
    script.onload = () => {
      this.overrideSendConsent();
    };
  }

  private overrideSendConsent(): void {
    const originalGetFormValues = window.getFormValues;

    window.getFormValues = (selectedLang: string) => {
      window.setDataPrincipalIdList = () => {
        window.dataPrincipalIdList = [];
        const email = this.email?.value || '';
        window.dataPrincipalIdList.push({ key: "email", value: email });
      };

      window.setDataPrincipalIdList();
      window.createConsentRequestList = [];

      const consentDiv = document.getElementById("consent-root");
      const checkboxes = consentDiv?.querySelectorAll('input[type="checkbox"]:checked');
      const radioButtons = consentDiv?.querySelectorAll('input[type="radio"]:checked');
      const dropdowns = consentDiv?.querySelectorAll("select");

      const pushConsent = (permissionId: string, label: string) => {
        let existing = window.createConsentRequestList.find((req: any) => req.permissionId === permissionId);
        if (existing) {
          existing.optedFor.push(label);
        } else {
          window.createConsentRequestList.push({
            dataPrincipalIdList: window.dataPrincipalIdList,
            permissionId,
            consentReceivedType: "FORMS",
            optedFor: [label],
            consentLanguage: selectedLang
          });
        }
      };

      checkboxes?.forEach((checkbox: any) => {
        const label = checkbox.closest("label") ? checkbox.closest("label").textContent.trim() : checkbox.value;
        pushConsent(checkbox.name, label);
      });

      radioButtons?.forEach((radio: any) => {
        const label = radio.closest("label") ? radio.closest("label").textContent.trim() : radio.value;
        pushConsent(radio.name, label);
      });

      dropdowns?.forEach((drop: any) => {
        const selected = drop.options[drop.selectedIndex];
        pushConsent(drop.name, selected.textContent);
      });

      document.querySelectorAll("#consent-root [name]").forEach((el: any) => {
        if (!window.createConsentRequestList.some((req: any) => req.permissionId === el.name)) {
          window.createConsentRequestList.push({
            dataPrincipalIdList: window.dataPrincipalIdList,
            permissionId: el.name,
            consentReceivedType: "FORMS",
            optedFor: [],
            consentLanguage: selectedLang
          });
        }
      });

      this.consentData = window.createConsentRequestList;
      this.consentSubmitted = true;
    };
  }

  private getConsentScriptContent(): string {
    return `
      const {
        consentFormId,
        apiUrl,
        submitApiUrl,
        showButtons,
        showLanguageDropdown,
        enableCheckboxes,
        enableRadioButtons,
        enableDropdowns
      } = window.consentWidgetConfig;

      let createConsentRequestList = [];
      let dataPrincipalIdList = [];

      async function fetchConsentData() {
        try {
          const res = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ consentFormId })
          });
          const result = await res.json();
          const data = result?.[0] || result?.response?.[0];

          if (!data) {
            document.getElementById("consent-root").innerText = "Consent data not found.";
            return;
          }

          renderConsent(data, data.languages?.[0]?.toLowerCase() || "en");
        } catch (e) {
          document.getElementById("consent-root").innerText = "Error loading consent.";
        }
      }

      function renderConsent(data, selectedLang) {
        const root = document.getElementById("consent-root");
        root.innerHTML = "";
        const branding = data.branding || {};

        let permissions = [];
        if (Array.isArray(data.consentForm)) {
          permissions = data.consentForm.flatMap(cf => cf.permissions || []);
        } else if (Array.isArray(data.permissions)) {
          permissions = data.permissions;
        }

        const logoArea = document.getElementById("logo-area");
        logoArea.innerHTML = "";
        logoArea.classList.remove("left", "center", "right");

        const align = (branding.logoAlignment || "left").toLowerCase();
        logoArea.classList.add(["left", "center", "right"].includes(align) ? align : "left");

        const wrapper = document.createElement("div");
        wrapper.style.display = "flex";

        if (align === "center") {
          wrapper.style.flexDirection = "column";
        } else if (align === "right") {
          wrapper.style.flexDirection = "row-reverse";
        } else {
          wrapper.style.flexDirection = "row";
        }

        wrapper.style.alignItems = "center";
        wrapper.style.gap = "5px";

        if (branding.logo) {
          const img = document.createElement("img");
          img.src = branding.logo;
          img.alt = branding.companyName || "Logo";
          img.className = "branding-logo";
          img.onerror = () => img.classList.add("hidden");
          wrapper.appendChild(img);
        }

        if (branding.companyName) {
          const nameDiv = document.createElement("div");
          nameDiv.innerText = branding.companyName;
          nameDiv.classList.add("company-name");

          if (branding.headerFontColor) nameDiv.style.color = branding.headerFontColor;
          if (branding.headerFontFamily) nameDiv.style.fontFamily = branding.headerFontFamily;
          if (branding.headerFontSize) {
            const sizeMap = { small: "14px", medium: "16px", large: "20px" };
            const sz = String(branding.headerFontSize).toLowerCase();
            nameDiv.style.fontSize = sizeMap[sz] || branding.headerFontSize;
          }
          if (branding.headerFontStyle) {
            const styleLower = String(branding.headerFontStyle).toLowerCase();
            if (styleLower.includes("italic")) nameDiv.style.fontStyle = "italic";
            if (styleLower.includes("bold")) nameDiv.style.fontWeight = "bold";
            if (styleLower.includes("normal")) {
              nameDiv.style.fontStyle = "normal";
              nameDiv.style.fontWeight = "400";
            }
          }

          if (branding.companySubtitle) {
            const subEl = document.createElement("div");
            subEl.className = "company-subtitle";
            subEl.innerText = branding.companySubtitle;
            if (branding.subtitleFontSize) subEl.style.fontSize = branding.subtitleFontSize;
            if (branding.subtitleFontColor) subEl.style.color = branding.subtitleFontColor;
            nameDiv.appendChild(subEl);
          }

          wrapper.appendChild(nameDiv);
        }

        logoArea.appendChild(wrapper);

        const langWrapper = document.getElementById("language-wrapper");
        const langSelect = document.getElementById("langSelect");
        if (showLanguageDropdown && data.languages?.length >= 1) {
          langWrapper.style.display = "block";
          langSelect.innerHTML = "";
          data.languages.forEach(lang => {
            const opt = document.createElement("option");
            opt.value = lang.toLowerCase();
            opt.text = lang;
            if (opt.value === selectedLang) opt.selected = true;
            langSelect.appendChild(opt);
          });
          langSelect.onchange = () => renderConsent(data, langSelect.value);
        } else {
          langWrapper.style.display = "none";
        }

        if (!permissions.length) {
          root.innerHTML = "<p>No consent items found.</p>";
          return;
        }

        permissions.forEach(perm => {
          const block = document.createElement("div");
          block.className = "permission-block";

          const tr = perm.permissionTranslation?.find(pt => pt.language.toLowerCase() === selectedLang);
          const htmlString = (tr?.text || perm.text || "").trim();

          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = htmlString;

          const children = Array.from(tempDiv.children);

          if (children.length > 0) {
            children.forEach((child, index) => {
              const el = document.createElement(child.tagName.toLowerCase());
              el.innerHTML = child.innerHTML;

              if (child.getAttribute("style")) {
                el.setAttribute("style", child.getAttribute("style"));
              }

              if (
                /^h[1-6]$/i.test(child.tagName) &&
                !/font-weight/i.test(child.getAttribute("style") || "")
              ) {
                el.style.fontWeight = "normal";
              }

              el.style.display = "block";
              el.style.margin = "2px 0";
              el.style.lineHeight = "1.4";
              el.setAttribute("data-translate-text", perm.id);

              if (perm.mandatory && index === children.length - 1) {
                el.innerHTML += ' <span class="mandatory">*</span>';
              }

              block.appendChild(el);
            });
          } else {
            const p = document.createElement("p");
            p.textContent = htmlString.replace(/<[^>]*>/g, "").trim();
            p.setAttribute("data-translate-text", perm.id);

            if (perm.mandatory) {
              p.innerHTML += ' <span class="mandatory">*</span>';
            }

            block.appendChild(p);
          }

          const options = tr?.options || perm.options || [];

          if (perm.elementType === 'CHECKBOX' && enableCheckboxes) {
            options.forEach(opt => {
              const label = document.createElement("label");
              const input = document.createElement("input");
              input.type = "checkbox";
              input.name = perm.id;
              input.value = opt;
              input.onchange = () => window.getFormValues && window.getFormValues(selectedLang);
              label.appendChild(input);
              label.append(" " + opt);
              block.appendChild(label);
            });
          }

          if (perm.elementType === 'RADIOBUTTON' && enableRadioButtons) {
            options.forEach(opt => {
              const label = document.createElement("label");
              const input = document.createElement("input");
              input.type = "radio";
              input.name = perm.id;
              input.value = opt;
              input.onchange = () => window.getFormValues && window.getFormValues(selectedLang);
              label.appendChild(input);
              label.append(" " + opt);
              block.appendChild(label);
            });
          }

          if (perm.elementType === 'DROPDOWN' && enableDropdowns) {
            const select = document.createElement("select");
            select.name = perm.id;
            select.onchange = () => window.getFormValues && window.getFormValues(selectedLang);
            options.forEach(opt => {
              const option = document.createElement("option");
              option.value = opt;
              option.text = opt;
              select.appendChild(option);
            });
            block.appendChild(select);
          }

          root.appendChild(block);
        });
      }

      fetchConsentData();
    `;
  }

  onSubmit(): void {
    if (this.registerForm.invalid) {
      return;
    }

    if (!this.consentSubmitted) {
      this.errorMessage = 'Please complete the consent form';
      return;
    }

    this.isLoading = true;
    this.errorMessage = '';

    const registrationData = {
      name: this.registerForm.value.name,
      email: this.registerForm.value.email
    };

    // Update consent data with current email value before submission
    const currentEmail = this.registerForm.value.email;
    const updatedConsentData = this.consentData.map((consent: any) => ({
      ...consent,
      dataPrincipalIdList: [{ key: "email", value: currentEmail }]
    }));

    // Call the new registration API
    this.http.post('https://qa-op.pre-dataprivacy.com/cpm-api/dsci/register', registrationData)
      .subscribe({
        next: (response: any) => {
          if (response.createUserStatusCode === 200) {
            // Submit consent data with updated email
            this.http.post('https://qa-op.pre-dataprivacy.com/cpm-api/consent/v1/createOrUpdateConsent',
              { createConsentRequestDtoWrapper: updatedConsentData })
              .subscribe({
                next: () => {
                  alert('Registration successful! You can now login.');
                  this.router.navigate(['/login']);
                },
                error: (error) => {
                  this.isLoading = false;
                  this.errorMessage = 'Registration successful but consent submission failed.';
                }
              });
          } else {
            this.isLoading = false;
            this.errorMessage = response.createUserStatusMessage || 'Registration failed.';
          }
        },
        error: (error) => {
          this.isLoading = false;
          this.errorMessage = error.error?.message || 'Registration failed. Please try again.';
        }
      });
  }
}
